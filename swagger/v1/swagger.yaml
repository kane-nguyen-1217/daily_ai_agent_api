---
openapi: 3.0.1
info:
  title: Daily AI Agent API V1
  version: v1
  description: |
    API for managing daily AI agent tasks, including authentication, OAuth integrations, 
    Telegram bot linking, automation settings, scheduler jobs, AI summaries, crypto data, 
    alerts, and n8n webhooks.
    
    ## Authentication
    Most endpoints require a JWT token. Include it in the Authorization header:
    `Authorization: Bearer <your_token>`
servers:
  - url: http://localhost:3000
    description: Development server
  - url: https://api.pers-ai-agent.dev
    description: Production server
paths:
  /health:
    get:
      summary: Health check
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  timestamp:
                    type: string
                  environment:
                    type: string
  
  /api/v1/auth/register:
    post:
      summary: Register a new user
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - full_name
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: "password123"
                password_confirmation:
                  type: string
                  format: password
                  example: "password123"
                full_name:
                  type: string
                  example: "John Doe"
                timezone:
                  type: string
                  example: "UTC"
            examples:
              newUser:
                summary: New user registration
                value:
                  email: "newuser@example.com"
                  password: "password123"
                  password_confirmation: "password123"
                  full_name: "John Doe"
                  timezone: "America/New_York"
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              examples:
                success:
                  summary: Successful registration
                  value:
                    message: "User created successfully"
                    token: "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjE3NjQwODczNDZ9.XttHad8oGL9dOuZnenVZJi4xFhJvls6M4NGp3hhWAGY"
                    user:
                      id: 1
                      email: "newuser@example.com"
                      full_name: "John Doe"
                      timezone: "America/New_York"
                      active: true
                      created_at: "2025-11-24T16:15:46.234Z"
        '422':
          description: Validation error
          content:
            application/json:
              examples:
                validation_error:
                  summary: Validation failed
                  value:
                    errors: ["Email has already been taken", "Password is too short"]
  
  /api/v1/auth/login:
    post:
      summary: Login user
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                password:
                  type: string
                  format: password
                  example: "password123"
            examples:
              login:
                summary: User login
                value:
                  email: "testuser@example.com"
                  password: "password123"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              examples:
                success:
                  summary: Successful login
                  value:
                    message: "Login successful"
                    token: "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjE3NjQwODczNTV9.s8Htx92wT5kAYLhPbEeQItEbrGexgF6eRqS9d8AhlaQ"
                    refresh_token: "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjE3NjQ2MDU3NTV9.FqAzxkDRCICzah6wz7i6w8xqcImPFiLFpq8oJIevQik"
                    user:
                      id: 1
                      email: "testuser@example.com"
                      full_name: "Test User"
                      timezone: "UTC"
                      active: true
                      created_at: "2025-11-24T16:15:46.234Z"
        '401':
          description: Invalid credentials
          content:
            application/json:
              examples:
                invalid_credentials:
                  summary: Invalid email or password
                  value:
                    error: "Invalid email or password"
  
  /api/v1/auth/refresh:
    post:
      summary: Refresh access token
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Token refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid token
  
  /api/v1/auth/logout:
    post:
      summary: Logout user
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
        '401':
          description: Unauthorized
  
  /api/v1/users/profile:
    get:
      summary: Get user profile
      tags:
        - Users
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
    put:
      summary: Update user profile
      tags:
        - Users
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
  
  /api/v1/oauth_tokens:
    get:
      summary: List OAuth tokens
      tags:
        - OAuth Tokens
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of OAuth tokens
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OAuthToken'
        '401':
          description: Unauthorized
    post:
      summary: Create OAuth token
      tags:
        - OAuth Tokens
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthTokenInput'
      responses:
        '201':
          description: OAuth token created
        '401':
          description: Unauthorized
  
  /api/v1/oauth_tokens/{id}:
    delete:
      summary: Delete OAuth token
      tags:
        - OAuth Tokens
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Token deleted
        '401':
          description: Unauthorized
        '404':
          description: Token not found
  
  /api/v1/oauth_tokens/google/authorize:
    get:
      summary: Get Google OAuth authorization URL
      tags:
        - OAuth Tokens
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Authorization URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  authorization_url:
                    type: string
        '401':
          description: Unauthorized
  
  /api/v1/oauth_tokens/google/callback:
    post:
      summary: Google OAuth callback
      tags:
        - OAuth Tokens
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
      responses:
        '200':
          description: OAuth token saved
        '401':
          description: Unauthorized
  
  /api/v1/telegram_links:
    get:
      summary: List Telegram links
      tags:
        - Telegram
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of Telegram links
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TelegramLink'
        '401':
          description: Unauthorized
    post:
      summary: Create Telegram link
      tags:
        - Telegram
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TelegramLinkInput'
      responses:
        '201':
          description: Telegram link created
        '401':
          description: Unauthorized
  
  /api/v1/telegram_links/{id}:
    delete:
      summary: Delete Telegram link
      tags:
        - Telegram
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Link deleted
        '401':
          description: Unauthorized
  
  /api/v1/telegram_links/verify:
    post:
      summary: Verify Telegram link
      tags:
        - Telegram
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                verification_code:
                  type: string
      responses:
        '200':
          description: Link verified
        '401':
          description: Unauthorized
  
  /api/v1/automation_settings:
    get:
      summary: List automation settings
      tags:
        - Automation
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of automation settings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AutomationSetting'
        '401':
          description: Unauthorized
    post:
      summary: Create automation setting
      tags:
        - Automation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AutomationSettingInput'
      responses:
        '201':
          description: Automation setting created
        '401':
          description: Unauthorized
  
  /api/v1/automation_settings/{id}:
    get:
      summary: Get automation setting
      tags:
        - Automation
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Automation setting details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AutomationSetting'
        '401':
          description: Unauthorized
        '404':
          description: Not found
    put:
      summary: Update automation setting
      tags:
        - Automation
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AutomationSettingInput'
      responses:
        '200':
          description: Automation setting updated
        '401':
          description: Unauthorized
    delete:
      summary: Delete automation setting
      tags:
        - Automation
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Automation setting deleted
        '401':
          description: Unauthorized
  
  /api/v1/scheduler_jobs:
    get:
      summary: List scheduler jobs
      tags:
        - Scheduler
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of scheduler jobs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SchedulerJob'
        '401':
          description: Unauthorized
    post:
      summary: Create scheduler job
      tags:
        - Scheduler
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SchedulerJobInput'
      responses:
        '201':
          description: Scheduler job created
        '401':
          description: Unauthorized
  
  /api/v1/scheduler_jobs/{id}:
    get:
      summary: Get scheduler job
      tags:
        - Scheduler
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Scheduler job details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchedulerJob'
        '401':
          description: Unauthorized
    put:
      summary: Update scheduler job
      tags:
        - Scheduler
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SchedulerJobInput'
      responses:
        '200':
          description: Scheduler job updated
        '401':
          description: Unauthorized
    delete:
      summary: Delete scheduler job
      tags:
        - Scheduler
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Scheduler job deleted
        '401':
          description: Unauthorized
  
  /api/v1/scheduler_jobs/{id}/run:
    post:
      summary: Run scheduler job now
      tags:
        - Scheduler
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Job queued
        '401':
          description: Unauthorized
  
  /api/v1/scheduler_jobs/{id}/enable:
    put:
      summary: Enable scheduler job
      tags:
        - Scheduler
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Job enabled
        '401':
          description: Unauthorized
  
  /api/v1/scheduler_jobs/{id}/disable:
    put:
      summary: Disable scheduler job
      tags:
        - Scheduler
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Job disabled
        '401':
          description: Unauthorized
  
  /api/v1/ai_summaries:
    get:
      summary: List AI summaries
      tags:
        - AI Summaries
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of AI summaries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AiSummary'
        '401':
          description: Unauthorized
    post:
      summary: Create AI summary
      tags:
        - AI Summaries
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiSummaryInput'
      responses:
        '201':
          description: AI summary created
        '401':
          description: Unauthorized
  
  /api/v1/ai_summaries/{id}:
    get:
      summary: Get AI summary
      tags:
        - AI Summaries
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: AI summary details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AiSummary'
        '401':
          description: Unauthorized
  
  /api/v1/ai_summaries/generate:
    post:
      summary: Generate new AI summary
      tags:
        - AI Summaries
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                summary_type:
                  type: string
                  enum: [daily, weekly, monthly]
                date:
                  type: string
                  format: date
      responses:
        '202':
          description: Summary generation started
        '401':
          description: Unauthorized
  
  /api/v1/crypto_data:
    get:
      summary: List crypto data
      tags:
        - Crypto Data
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of crypto data
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CryptoData'
        '401':
          description: Unauthorized
  
  /api/v1/crypto_data/{id}:
    get:
      summary: Get crypto data by ID
      tags:
        - Crypto Data
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Crypto data details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CryptoData'
        '401':
          description: Unauthorized
  
  /api/v1/crypto_data/prices:
    get:
      summary: Get current crypto prices
      tags:
        - Crypto Data
      security:
        - bearerAuth: []
      parameters:
        - name: symbols
          in: query
          schema:
            type: string
          description: Comma-separated list of crypto symbols (e.g., BTC,ETH,BNB)
      responses:
        '200':
          description: Current prices
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
  
  /api/v1/crypto_data/historical/{symbol}:
    get:
      summary: Get historical crypto data
      tags:
        - Crypto Data
      security:
        - bearerAuth: []
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: days
          in: query
          schema:
            type: integer
          description: Number of days of historical data
      responses:
        '200':
          description: Historical data
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
  
  /api/v1/alerts:
    get:
      summary: List alerts
      tags:
        - Alerts
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of alerts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Alert'
        '401':
          description: Unauthorized
    post:
      summary: Create alert
      tags:
        - Alerts
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlertInput'
      responses:
        '201':
          description: Alert created
        '401':
          description: Unauthorized
  
  /api/v1/alerts/{id}:
    get:
      summary: Get alert
      tags:
        - Alerts
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Alert details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'
        '401':
          description: Unauthorized
  
  /api/v1/alerts/recent:
    get:
      summary: Get recent alerts
      tags:
        - Alerts
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Recent alerts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Alert'
        '401':
          description: Unauthorized
  
  /api/v1/alerts/{id}/acknowledge:
    put:
      summary: Acknowledge alert
      tags:
        - Alerts
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Alert acknowledged
        '401':
          description: Unauthorized
  
  /api/v1/webhooks/n8n/workflow:
    post:
      summary: n8n workflow callback
      tags:
        - Webhooks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook received
        '401':
          description: Unauthorized
  
  /api/v1/webhooks/n8n/execute:
    post:
      summary: Execute n8n workflow
      tags:
        - Webhooks
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                workflow_id:
                  type: string
                data:
                  type: object
      responses:
        '200':
          description: Workflow execution started
        '401':
          description: Unauthorized
  
  /api/v1/webhooks/n8n/status/{job_id}:
    get:
      summary: Get n8n job status
      tags:
        - Webhooks
      security:
        - bearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  result:
                    type: object
        '401':
          description: Unauthorized
  
  /api/v1/calendar/{provider}/connect:
    get:
      summary: Get OAuth authorization URL for calendar provider
      tags:
        - Calendar
      security:
        - bearerAuth: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
            enum: [google, microsoft]
      responses:
        '200':
          description: Authorization URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  authorization_url:
                    type: string
              examples:
                google:
                  summary: Google Calendar authorization
                  value:
                    authorization_url: "https://accounts.google.com/o/oauth2/v2/auth?..."
        '400':
          description: Invalid provider
        '401':
          description: Unauthorized
  
  /api/v1/calendar/{provider}/callback:
    get:
      summary: OAuth callback endpoint for calendar provider
      description: This endpoint is called by the OAuth provider after user authorization. It exchanges the authorization code for tokens and creates/updates the calendar account.
      tags:
        - Calendar
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
            enum: [google, microsoft]
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from OAuth provider
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: State parameter containing user information
      responses:
        '302':
          description: Redirects to frontend with success/error status
        '400':
          description: Missing authorization code
        '404':
          description: User not found

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  
  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
        name:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    AuthResponse:
      type: object
      properties:
        token:
          type: string
        refresh_token:
          type: string
        user:
          $ref: '#/components/schemas/User'
    
    OAuthToken:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        provider:
          type: string
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
    
    OAuthTokenInput:
      type: object
      properties:
        provider:
          type: string
        access_token:
          type: string
        refresh_token:
          type: string
        expires_at:
          type: string
          format: date-time
    
    TelegramLink:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        telegram_user_id:
          type: string
        telegram_username:
          type: string
        active:
          type: boolean
        created_at:
          type: string
          format: date-time
    
    TelegramLinkInput:
      type: object
      properties:
        telegram_user_id:
          type: string
        telegram_username:
          type: string
    
    AutomationSetting:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        automation_type:
          type: string
        enabled:
          type: boolean
        configuration:
          type: object
        created_at:
          type: string
          format: date-time
    
    AutomationSettingInput:
      type: object
      properties:
        automation_type:
          type: string
        enabled:
          type: boolean
        configuration:
          type: object
    
    SchedulerJob:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        job_type:
          type: string
        enabled:
          type: boolean
        schedule_time:
          type: string
        timezone:
          type: string
        last_run_at:
          type: string
          format: date-time
        next_run_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
    
    SchedulerJobInput:
      type: object
      properties:
        job_type:
          type: string
        enabled:
          type: boolean
        schedule_time:
          type: string
        timezone:
          type: string
        job_config:
          type: object
    
    AiSummary:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        summary_type:
          type: string
        summary_date:
          type: string
          format: date
        content:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
    
    AiSummaryInput:
      type: object
      properties:
        summary_type:
          type: string
        summary_date:
          type: string
          format: date
        content:
          type: string
    
    CryptoData:
      type: object
      properties:
        id:
          type: integer
        symbol:
          type: string
        name:
          type: string
        current_price:
          type: number
        market_cap:
          type: number
        volume_24h:
          type: number
        price_change_24h:
          type: number
        cached_at:
          type: string
          format: date-time
    
    Alert:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        alert_type:
          type: string
        severity:
          type: string
        title:
          type: string
        message:
          type: string
        acknowledged:
          type: boolean
        created_at:
          type: string
          format: date-time
    
    AlertInput:
      type: object
      properties:
        alert_type:
          type: string
        severity:
          type: string
        title:
          type: string
        message:
          type: string
